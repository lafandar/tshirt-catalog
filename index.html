<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T-Shirt Brand Catalog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { opacity: 0; visibility: hidden; transition: opacity 300ms ease-out, visibility 0s 300ms; }
        .modal.is-open { opacity: 1; visibility: visible; transition: opacity 300ms ease-out; }
        .modal-content { transform: scale(0.95); transition: transform 300ms ease-out; }
        .modal.is-open .modal-content { transform: scale(1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .option-list::-webkit-scrollbar { width: 4px; }
        .option-list::-webkit-scrollbar-track { background: #f1f1f1; }
        .option-list::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 10px; }
        .chevron-icon { transition: transform 0.2s ease-in-out; }
        input[type="checkbox"]:disabled + span { color: #a0aec0; cursor: not-allowed; }
        
        /* Mobile-First Image Navigation Buttons */
        .image-nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background-color: rgba(0,0,0,0.4); color: white; border-radius: 9999px;
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            border: none; cursor: pointer; opacity: 1; transition: opacity 0.2s;
        }
        /* Hide on desktop unless hovered */
        @media (min-width: 1024px) {
            .image-nav-btn {
                opacity: 0;
            }
            .relative:hover .image-nav-btn {
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">LAFANDAR T-Shirt Catalog</h1>
            <p class="text-base sm:text-lg text-gray-600 mt-2">Select multiple options for easy bulk ordering.</p>
        </header>

        <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6">
            <div id="loading" class="col-span-full flex justify-center items-center h-64"><div class="loader"></div></div>
        </div>

        <div class="fixed bottom-6 right-6 z-40">
            <button id="view-cart-button" class="bg-indigo-600 text-white rounded-full p-4 shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-transform transform hover:scale-110">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
            </button>
        </div>
    </div>

    <!-- Modals and Toast -->
    <div id="cart-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg mx-auto">
            <div class="p-4 border-b flex justify-between items-center"><h2 class="text-2xl font-semibold">Your Order</h2><button class="close-modal-btn text-gray-500 hover:text-gray-800 text-3xl leading-none" aria-label="Close">&times;</button></div>
            <div id="cart-items" class="p-6 max-h-80 overflow-y-auto"></div>
            <div class="p-4 bg-gray-50 border-t flex justify-between items-center">
                <div><p class="text-lg font-semibold">Total: <span id="cart-total">â‚¹0.00</span></p><button id="clear-cart-btn" class="text-xs text-red-500 hover:text-red-700 font-medium mt-1" style="display: none;">Clear Cart</button></div>
                <button id="checkout-button" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition">Proceed to Checkout</button>
            </div>
        </div>
    </div>
    <div id="details-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md mx-auto"><div class="p-4 border-b flex justify-between items-center"><h2 class="text-2xl font-semibold">Your Details</h2><button class="close-modal-btn text-gray-500 hover:text-gray-800 text-3xl leading-none" aria-label="Close">&times;</button></div><div class="p-6"><form id="owner-details-form"><div class="mb-4"><label for="shop-name" class="block text-sm font-medium text-gray-700 mb-1">Shop Name</label><input type="text" id="shop-name" name="shopName" class="w-full p-2 border border-gray-300 rounded-md" required></div><div class="mb-4"><label for="owner-name" class="block text-sm font-medium text-gray-700 mb-1">Your Name</label><input type="text" id="owner-name" name="ownerName" class="w-full p-2 border border-gray-300 rounded-md" required></div><div class="mb-4"><label for="shop-address" class="block text-sm font-medium text-gray-700 mb-1">Shop Address</label><textarea id="shop-address" name="shopAddress" rows="3" class="w-full p-2 border border-gray-300 rounded-md" required></textarea></div></form></div><div class="p-4 bg-gray-50 border-t flex justify-end"><button id="send-whatsapp-button" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition">Confirm & Send Order</button></div></div>
    </div>
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-md opacity-0 transition-opacity duration-300 z-50">Item(s) added to cart!</div>
    
    <!-- Updated Image Viewer Modal -->
    <div id="image-viewer-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="relative max-w-4xl w-full max-h-full flex items-center justify-center">
            <button id="close-image-viewer" class="absolute -top-2 -right-2 text-white bg-black bg-opacity-50 rounded-full h-8 w-8 flex items-center justify-center text-2xl z-20" aria-label="Close">&times;</button>
            <button id="viewer-prev-btn" class="image-nav-btn left-2 lg:-left-12 z-10" style="opacity:1;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <img id="full-view-image" src="" alt="Full view" class="max-w-full max-h-screen object-contain rounded-lg">
            <button id="viewer-next-btn" class="image-nav-btn right-2 lg:-right-12 z-10" style="opacity:1;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
        </div>
    </div>

    <!-- Custom Alert & Confirm Modals -->
    <div id="alert-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm mx-auto"><div class="p-4 border-b"><h2 id="alert-title" class="text-xl font-semibold">Notice</h2></div><div id="alert-message" class="p-6"></div><div class="p-4 bg-gray-50 border-t flex justify-end"><button id="alert-ok-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">OK</button></div></div></div>
    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm mx-auto"><div class="p-4 border-b"><h2 id="confirm-title" class="text-xl font-semibold">Confirmation</h2></div><div id="confirm-message" class="p-6"></div><div class="p-4 bg-gray-50 border-t flex justify-end space-x-2"><button id="confirm-cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button><button id="confirm-ok-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Confirm</button></div></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAuO5iyXCHYZS9nS2BViu-259sb2CUSZjo",
          authDomain: "tshirt-catalog-v2.firebaseapp.com",
          projectId: "tshirt-catalog-v2",
          storageBucket: "tshirt-catalog-v2.firebasestorage.app",
          messagingSenderId: "428518895959",
          appId: "1:428518895959:web:8e1fccd4d6f1e2c8b00e12"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            const yourWhatsAppNumber = '918210746035'; 
            let products = [];
            let cart = {}; 
            let toastTimer;
            let confirmCallback = null;
            let viewerState = { images: [], currentIndex: 0 };
            const preloadedUrls = new Set();

            function preloadImages(urls) {
                if (!urls) return;
                urls.forEach(url => {
                    if (!preloadedUrls.has(url)) {
                        const img = new Image();
                        img.src = url;
                        preloadedUrls.add(url);
                    }
                });
            }

            function loadCart() { const savedCart = localStorage.getItem('tshirtCart'); if (savedCart) cart = JSON.parse(savedCart); }
            function saveCart() { localStorage.setItem('tshirtCart', JSON.stringify(cart)); }

            const productGrid = document.getElementById('product-grid');
            const loadingSpinner = document.getElementById('loading');
            const cartModal = document.getElementById('cart-modal');
            const detailsModal = document.getElementById('details-modal');
            const imageViewerModal = document.getElementById('image-viewer-modal');
            const alertModal = document.getElementById('alert-modal');
            const confirmModal = document.getElementById('confirm-modal');
            const fullViewImage = document.getElementById('full-view-image');
            const closeImageViewerBtn = document.getElementById('close-image-viewer');
            const viewerPrevBtn = document.getElementById('viewer-prev-btn');
            const viewerNextBtn = document.getElementById('viewer-next-btn');

            const viewCartButton = document.getElementById('view-cart-button');
            const checkoutButton = document.getElementById('checkout-button');
            const sendWhatsappButton = document.getElementById('send-whatsapp-button');
            const cartItemsContainer = document.getElementById('cart-items');
            const cartCount = document.getElementById('cart-count');
            const cartTotal = document.getElementById('cart-total');
            const clearCartBtn = document.getElementById('clear-cart-btn');
            const toast = document.getElementById('toast');
            const ownerDetailsForm = document.getElementById('owner-details-form');

            function showAlert(title, message) {
                document.getElementById('alert-title').textContent = title;
                document.getElementById('alert-message').innerHTML = message;
                toggleModal(alertModal, true);
            }

            function showConfirm(title, message, onConfirm) {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').innerHTML = message;
                confirmCallback = onConfirm;
                toggleModal(confirmModal, true);
            }

            document.getElementById('alert-ok-btn').addEventListener('click', () => toggleModal(alertModal, false));
            document.getElementById('confirm-ok-btn').addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                toggleModal(confirmModal, false);
            });
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => toggleModal(confirmModal, false));

            async function fetchProducts() {
                try {
                    const snapshot = await db.collection('products').orderBy("name").get();
                    if (snapshot.empty) { productGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">No designs have been added yet.</p>'; return; }
                    snapshot.forEach(doc => products.push({ id: doc.id, ...doc.data() }));
                    renderProducts();
                } catch (error) { console.error("Error fetching products: ", error); productGrid.innerHTML = '<p class="col-span-full text-center text-red-500">Could not load designs.</p>'; } 
                finally { if (loadingSpinner) loadingSpinner.style.display = 'none'; }
            }

            function renderProducts() {
                productGrid.innerHTML = '';
                products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-md overflow-hidden flex flex-col';
                    card.dataset.productId = product.id;
                    
                    const hasVariants = product.variants && Object.keys(product.variants).length > 0;
                    
                    const createCollapsibleCheckboxList = (title, items, type, isVariant = false) => {
                        let checkboxHTML; let gridClass = 'grid-cols-2';
                        if (isVariant) {
                            checkboxHTML = Object.keys(items).map(name => `<label class="flex items-center justify-between text-sm p-1 rounded hover:bg-gray-100"><span class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 rounded" data-type="variant" value="${name}"><span>${name}</span></span><span class="font-medium text-gray-600">â‚¹${items[name]}</span></label>`).join('');
                            gridClass = 'flex flex-col gap-1';
                        } else {
                            if (type === 'size') gridClass = 'grid-cols-3';
                            checkboxHTML = items.map(item => `<label class="flex items-center space-x-2 text-sm"><input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 rounded" data-type="${type}" value="${item}"><span>${item}</span></label>`).join('');
                        }
                        return `<div class="border-t"><button type="button" class="collapsible-toggle flex justify-between items-center w-full py-2 text-sm font-semibold text-left"><span>${title}</span><svg class="chevron-icon w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></button><div class="collapsible-content hidden pl-2 pb-2"><div class="option-list ${gridClass} gap-1">${checkboxHTML}</div></div></div>`;
                    };

                    const variantSection = hasVariants ? createCollapsibleCheckboxList('Category', product.variants, 'variant', true) : '<p class="text-sm text-gray-500 p-2">Not Available</p>';
                    const sizeSection = createCollapsibleCheckboxList('Size', product.sizes, 'size');
                    const colorSection = createCollapsibleCheckboxList('Color', product.colors, 'color');
                    const mainImage = product.imageUrls && product.imageUrls.length > 0 ? product.imageUrls[0] : 'https://placehold.co/400x500/cccccc/ffffff?text=Image+Not+Found';
                    const hasMultipleImages = product.imageUrls && product.imageUrls.length > 1;

                    card.innerHTML = `
                        <div class="relative" data-image-index="0">
                           <img src="${mainImage}" alt="${product.name}" loading="lazy" class="product-image w-full h-64 object-cover cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/400x500/cccccc/ffffff?text=Image+Not+Found';">
                           ${hasMultipleImages ? `<button class="image-nav-btn card-prev-btn left-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button><button class="image-nav-btn card-next-btn right-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>` : ''}
                        </div>
                        <div class="p-4 flex flex-col flex-grow">
                            <h3 class="text-lg font-semibold mb-2">${product.name}</h3>
                            <div class="space-y-1 mt-auto pt-2">${variantSection}${sizeSection}${colorSection}</div>
                            <p class="stock-display text-center text-sm font-medium text-indigo-600 h-5 mt-2"></p>
                            <div class="flex items-center gap-2 border-t pt-3 mt-3">
                                <input type="number" min="1" value="1" class="quantity-input w-16 p-2 border border-gray-300 rounded-md text-center">
                                <button class="add-to-cart-btn flex-1 bg-indigo-500 text-white font-semibold py-2 px-3 text-sm rounded-md hover:bg-indigo-600 transition whitespace-nowrap">Add Selected</button>
                            </div>
                        </div>
                    `;
                    productGrid.appendChild(card);
                    
                    addSwipeListeners(card); // Add swipe functionality
                    const prevBtn = card.querySelector('.card-prev-btn');
                    const nextBtn = card.querySelector('.card-next-btn');
                    if (prevBtn && nextBtn) {
                        const changeCardImage = (isNext) => {
                            const imageContainer = card.querySelector('.relative[data-image-index]');
                            const img = card.querySelector('.product-image');
                            const urls = product.imageUrls;
                            if (!urls || urls.length < 2) return;
                            let currentIndex = parseInt(imageContainer.dataset.imageIndex, 10);
                            if (isNext) { currentIndex = (currentIndex + 1) % urls.length; } 
                            else { currentIndex = (currentIndex - 1 + urls.length) % urls.length; }
                            img.src = urls[currentIndex];
                            imageContainer.dataset.imageIndex = currentIndex;
                        };
                        prevBtn.addEventListener('click', (e) => { e.stopPropagation(); changeCardImage(false); });
                        nextBtn.addEventListener('click', (e) => { e.stopPropagation(); changeCardImage(true); });
                    }
                });
            }
            
            function addSwipeListeners(card) {
                const imageContainer = card.querySelector('.relative[data-image-index]');
                if (!imageContainer) return;
                let touchStartX = 0; let touchEndX = 0;
                imageContainer.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
                imageContainer.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe(card, imageContainer, touchStartX, touchEndX);
                }, { passive: true });
            }

            function handleSwipe(card, imageContainer, startX, endX) {
                const product = products.find(p => p.id === card.dataset.productId);
                if (!product || !product.imageUrls || product.imageUrls.length < 2) return;
                
                let currentIndex = parseInt(imageContainer.dataset.imageIndex, 10);
                if (endX < startX - 50) { currentIndex = (currentIndex + 1) % product.imageUrls.length; } 
                else if (endX > startX + 50) { currentIndex = (currentIndex - 1 + product.imageUrls.length) % product.imageUrls.length; } 
                else { return; }

                const img = card.querySelector('.product-image');
                img.src = product.imageUrls[currentIndex];
                imageContainer.dataset.imageIndex = currentIndex;
            }

            function addToCart(productId, category, quantity, size, color) {
                const product = products.find(p => p.id == productId); if (!product) return;
                const price = product.variants[category] || 0;
                const cartItemId = `${productId}-${category}-${size}-${color}`;
                if (cart[cartItemId]) { cart[cartItemId].quantity += quantity; } 
                else { cart[cartItemId] = { name: product.name, category, quantity, size, color, price }; }
            }
            
            function updateStockDisplay(card) {
                const productId = card.dataset.productId; const product = products.find(p => p.id === productId); if (!product) return;
                const stockInfo = product.stockInfo || {}; const stockDisplay = card.querySelector('.stock-display');
                const getSelected = (type) => Array.from(card.querySelectorAll(`input[data-type="${type}"]:checked`)).map(cb => cb.value);
                const selectedVariants = getSelected('variant'); const selectedSizes = getSelected('size'); const selectedColors = getSelected('color');
                if (selectedVariants.length === 1 && selectedSizes.length === 1 && selectedColors.length === 1) {
                    const stockKey = `${selectedVariants[0]}_${selectedSizes[0]}_${selectedColors[0]}`;
                    const cartItemId = `${productId}-${selectedVariants[0]}-${selectedSizes[0]}_${selectedColors[0]}`;
                    const totalStock = stockInfo[stockKey] || 0;
                    const quantityInCart = cart[cartItemId] ? cart[cartItemId].quantity : 0;
                    const displayStock = totalStock - quantityInCart;
                    stockDisplay.textContent = displayStock > 0 ? `${displayStock} in stock` : 'Out of stock';
                } else { stockDisplay.textContent = ''; }
            }

            productGrid.addEventListener('mouseover', (e) => {
                const card = e.target.closest('[data-product-id]');
                if (card) { const product = products.find(p => p.id === card.dataset.productId); if (product) preloadImages(product.imageUrls); }
            });

            productGrid.addEventListener('click', (e) => {
                const card = e.target.closest('[data-product-id]'); if (!card) return;
                if (e.target.classList.contains('product-image')) {
                    const product = products.find(p => p.id === card.dataset.productId);
                    const imageContainer = card.querySelector('.relative[data-image-index]');
                    if (product.imageUrls && product.imageUrls.length > 0) {
                        preloadImages(product.imageUrls);
                        viewerState.images = product.imageUrls;
                        viewerState.currentIndex = parseInt(imageContainer.dataset.imageIndex, 10);
                        updateImageViewer();
                        toggleModal(imageViewerModal, true);
                    }
                } else if (e.target.classList.contains('add-to-cart-btn')) {
                    const product = products.find(p => p.id === card.dataset.productId);
                    const cardBody = e.target.closest('.p-4');
                    const quantity = parseInt(cardBody.querySelector('.quantity-input').value, 10);
                    const getSelected = (type) => Array.from(cardBody.querySelectorAll(`input[data-type="${type}"]:checked`)).map(cb => cb.value);
                    const selectedVariants = getSelected('variant'); const selectedSizes = getSelected('size'); const selectedColors = getSelected('color');
                    if (isNaN(quantity) || quantity < 1) { showAlert("Invalid Quantity", "Please enter a valid quantity."); return; }
                    if (selectedVariants.length === 0 || selectedSizes.length === 0 || selectedColors.length === 0) { showAlert("Selection Missing", "Please select at least one option from each category."); return; }
                    let itemsAdded = 0; let unavailableItems = [];
                    selectedVariants.forEach(variant => {
                        selectedSizes.forEach(size => {
                            selectedColors.forEach(color => {
                                const stockKey = `${variant}_${size}_${color}`; const cartItemId = `${product.id}-${variant}-${size}-${color}`;
                                const availableStock = (product.stockInfo || {})[stockKey] || 0;
                                const quantityInCart = cart[cartItemId] ? cart[cartItemId].quantity : 0;
                                if (availableStock >= quantity + quantityInCart) { addToCart(product.id, variant, quantity, size, color); itemsAdded++; } 
                                else { unavailableItems.push(`- ${product.name} (${variant}, ${size}, ${color}) - Only ${Math.max(0, availableStock - quantityInCart)} left`); }
                            });
                        });
                    });
                    if (itemsAdded > 0) { updateCart(); showToast(); updateStockDisplay(card); }
                    if (unavailableItems.length > 0) { showAlert("Some Items Unavailable", "Insufficient stock for:<br><br><div class='text-left text-sm'>" + unavailableItems.join('<br>') + "</div>"); }
                }
                const toggle = e.target.closest('.collapsible-toggle');
                if (toggle) { toggle.nextElementSibling.classList.toggle('hidden'); toggle.querySelector('.chevron-icon').classList.toggle('rotate-180'); }
            });

            productGrid.addEventListener('change', (e) => { if (e.target.matches('input[type="checkbox"]')) { updateStockDisplay(e.target.closest('[data-product-id]')); } });

            function updateCart() {
                let totalItems = 0; let totalPrice = 0; cartItemsContainer.innerHTML = ''; const isCartEmpty = Object.keys(cart).length === 0;
                if (isCartEmpty) { cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center">Your cart is empty.</p>'; checkoutButton.disabled = true; checkoutButton.classList.add('opacity-50', 'cursor-not-allowed'); clearCartBtn.style.display = 'none'; } 
                else { checkoutButton.disabled = false; checkoutButton.classList.remove('opacity-50', 'cursor-not-allowed'); clearCartBtn.style.display = 'block';
                    for (const id in cart) { const item = cart[id]; totalItems += item.quantity; totalPrice += item.quantity * item.price; const el = document.createElement('div'); el.className = 'flex justify-between items-center py-3 border-b'; el.innerHTML = `<div><p class="font-semibold">${item.name} <span class="text-sm text-gray-500">(${item.category}, ${item.size}, ${item.color})</span></p><p class="text-sm text-gray-600">Qty: ${item.quantity} x â‚¹${item.price.toFixed(2)}</p></div><div class="text-right"><p class="font-semibold">â‚¹${(item.quantity * item.price).toFixed(2)}</p><button class="remove-from-cart-btn text-xs text-red-500 hover:text-red-700 font-medium" data-id="${id}">Remove</button></div>`; cartItemsContainer.appendChild(el); }
                }
                cartCount.textContent = totalItems; cartTotal.textContent = `â‚¹${totalPrice.toFixed(2)}`; saveCart();
            }
            function showToast() { clearTimeout(toastTimer); toast.classList.remove('opacity-0'); toastTimer = setTimeout(() => { toast.classList.add('opacity-0'); }, 2000); }
            function toggleModal(modal, show) { if (show) modal.classList.add('is-open'); else modal.classList.remove('is-open'); }
            
            cartItemsContainer.addEventListener('click', (e) => { 
                if (e.target.classList.contains('remove-from-cart-btn')) { 
                    const id = e.target.dataset.id; delete cart[id]; updateCart(); 
                    const card = document.querySelector(`[data-product-id="${id.split('-')[0]}"]`); if (card) updateStockDisplay(card);
                } 
            });

            function updateImageViewer() {
                if (viewerState.images.length > 0) fullViewImage.src = viewerState.images[viewerState.currentIndex];
                viewerPrevBtn.style.display = viewerState.images.length > 1 ? 'flex' : 'none';
                viewerNextBtn.style.display = viewerState.images.length > 1 ? 'flex' : 'none';
            }
            viewerPrevBtn.addEventListener('click', () => { viewerState.currentIndex = (viewerState.currentIndex - 1 + viewerState.images.length) % viewerState.images.length; updateImageViewer(); });
            viewerNextBtn.addEventListener('click', () => { viewerState.currentIndex = (viewerState.currentIndex + 1) % viewerState.images.length; updateImageViewer(); });

            viewCartButton.addEventListener('click', () => { updateCart(); toggleModal(cartModal, true); });
            checkoutButton.addEventListener('click', () => { toggleModal(cartModal, false); toggleModal(detailsModal, true); });
            document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => { const modal = e.target.closest('.modal'); if(modal) toggleModal(modal, false); }));
            closeImageViewerBtn.addEventListener('click', () => toggleModal(imageViewerModal, false));
            imageViewerModal.addEventListener('click', (e) => { if (e.target === imageViewerModal) toggleModal(imageViewerModal, false); });
            clearCartBtn.addEventListener('click', () => { showConfirm("Clear Cart", "Are you sure you want to clear your cart?", () => { cart = {}; updateCart(); document.querySelectorAll('[data-product-id]').forEach(updateStockDisplay); }); });
            sendWhatsappButton.addEventListener('click', () => { if (!ownerDetailsForm.checkValidity()) { ownerDetailsForm.reportValidity(); return; } const formData = new FormData(ownerDetailsForm); const ownerDetails = Object.fromEntries(formData.entries()); let message = `*New T-Shirt Order*\n\n*From:* ${ownerDetails.ownerName}\n*Shop:* ${ownerDetails.shopName}\n*Address:* ${ownerDetails.shopAddress}\n\n--- *Order Details* ---\n`; let totalPrice = 0; for (const id in cart) { const item = cart[id]; const itemTotal = item.quantity * item.price; totalPrice += itemTotal; message += `- *${item.name}* (${item.category}, ${item.size}, ${item.color})\n  *Qty:* ${item.quantity} x â‚¹${item.price.toFixed(2)} = *â‚¹${itemTotal.toFixed(2)}*\n`; } message += `\n*GRAND TOTAL: â‚¹${totalPrice.toFixed(2)}*\n\nThank you!`; const whatsappUrl = `https://wa.me/${yourWhatsAppNumber}?text=${encodeURIComponent(message)}`; window.open(whatsappUrl, '_blank'); });

            loadCart();
            updateCart();
            fetchProducts();
        });
    </script>
</body>
</html>

