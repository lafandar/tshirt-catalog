<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAFANDAR | T-Shirt Catalogue</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS for animations and styling -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .color-swatch {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        .color-swatch.selected {
            box-shadow: 0 0 0 3px #1e40af; /* A strong blue ring */
        }
        .size-btn.selected {
            background-color: #1e3a8a; /* Darker blue */
            color: white;
            border-color: #1e3a8a;
        }
        .product-image {
            transition: opacity 0.3s ease-in-out;
        }
        .fade-out {
            opacity: 0;
        }
        .toast {
            visibility: hidden;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease-in-out;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
        .cart-item-enter {
            opacity: 0;
            transform: translateX(-20px);
            transition: all 0.3s ease-out;
        }
        .cart-item-enter-active {
            opacity: 1;
            transform: translateX(0);
        }
        .design-option {
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
            position: relative;
        }
        .design-option:hover {
            transform: scale(1.05);
        }
        .design-option .selected-checkmark {
            display: none;
        }
        .design-option.selected .selected-checkmark {
            display: flex;
        }
        .design-option.selected img {
            filter: brightness(0.8);
        }
        #design-modal-content {
            transform: scale(0.95);
            transition: transform 0.2s ease-out;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .image-preloader {
            display: none;
        }
        .stock-error-message {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }
        .stock-error-message.show {
             max-height: 2rem; /* approx height */
             opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Welcome Gate -->
    <div id="welcome-modal" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-8 text-center">
            <h2 class="text-3xl font-bold mb-2 text-gray-800">Welcome to LAFANDAR</h2>
            <p class="text-gray-600 mb-6">Please enter your details to view the catalogue.</p>
            <form id="welcome-form">
                <div class="space-y-4">
                    <input type="text" id="welcome-name" required class="text-center block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Your Name">
                    <input type="tel" id="welcome-mobile" required class="text-center block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Your Mobile Number">
                </div>
                <div class="mt-6">
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700">Enter Catalogue</button>
                </div>
            </form>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 tracking-tight">
                    LAFANDAR CATALOGUE
                </h1>
                <div class="flex items-center gap-4">
                     <span id="customer-name-display" class="hidden text-sm font-semibold text-gray-700"></span>
                     <button id="view-order-btn" class="hidden text-sm font-semibold text-gray-600 hover:text-blue-600">My Last Order</button>
                    <button id="cart-button" class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-600 hover:text-gray-900 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <span id="cart-count" class="absolute -top-2 -right-2 bg-blue-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold">0</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Product Grid -->
        <main id="product-grid" class="container mx-auto px-4 sm:px-6 py-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div id="grid-loader" class="col-span-full flex flex-col items-center justify-center min-h-[50vh]">
                <div class="loader"></div>
                <p class="mt-4 text-gray-500">Loading Latest Collection...</p>
            </div>
        </main>
    </div>
    
    <!-- Shopping Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-end">
        <div id="cart-panel" class="w-full max-w-md bg-white h-full shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <!-- Cart Header -->
                <div class="flex justify-between items-center p-6 border-b">
                    <h2 class="text-2xl font-semibold">Your Cart</h2>
                    <button id="close-cart-btn" class="text-gray-500 hover:text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <!-- Cart Items -->
                <div id="cart-items-container" class="flex-grow p-6 overflow-y-auto">
                    <!-- Cart items will be injected here -->
                    <div id="empty-cart-message" class="text-center text-gray-500 mt-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                        <p class="mt-4 text-lg">Your cart is empty.</p>
                        <p class="text-sm">Looks like you haven't added anything yet.</p>
                    </div>
                </div>

                <!-- Cart Footer -->
                <div class="p-6 border-t bg-gray-50">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-medium">Subtotal</span>
                        <span id="cart-subtotal" class="text-xl font-bold">₹0.00</span>
                    </div>
                    <button id="whatsapp-btn" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors disabled:bg-gray-400 flex items-center justify-center gap-2">
                        <span>Review & Order</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order Summary Modal -->
    <div id="order-summary-modal" class="fixed inset-0 bg-white z-[70] hidden overflow-y-auto p-4 sm:p-6">
        <div class="container mx-auto max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                 <h2 class="text-2xl sm:text-3xl font-bold text-gray-900">Final Bill</h2>
                 <button id="close-summary-btn" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="bg-gray-50 rounded-lg p-6">
                <div id="summary-customer-details" class="mb-6 border-b pb-4"></div>
                <h3 class="text-xl font-semibold mb-4 border-b pb-3">Order Summary</h3>
                <div id="summary-items-container" class="space-y-4 mb-6">
                    <!-- Summary items will be injected here -->
                </div>
                <div class="border-t pt-4 space-y-2">
                    <div class="flex justify-between text-lg">
                        <span>Total Items:</span>
                        <span id="summary-total-items" class="font-medium">0</span>
                    </div>
                    <div class="flex justify-between text-xl font-bold">
                        <span>Grand Total:</span>
                        <span id="summary-grand-total">₹0.00</span>
                    </div>
                </div>
            </div>
             <div class="mt-8 flex flex-col sm:flex-row gap-4">
                <button id="confirm-order-btn" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors flex items-center justify-center gap-2 text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413 0 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.687-1.475L.057 24zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 4.315 1.731 6.086l.287.468-1.911 5.462 5.547-1.83z"/></svg>
                    Confirm & Send on WhatsApp
                </button>
            </div>
        </div>
    </div>


    <!-- Design Preview Modal -->
    <div id="design-modal" class="fixed inset-0 bg-black bg-opacity-75 z-[60] hidden items-center justify-center p-4" role="dialog" aria-modal="true">
        <div id="design-modal-content" class="bg-white rounded-lg shadow-2xl p-4 relative max-w-lg w-full">
            <button id="close-design-btn" class="absolute -top-4 -right-4 bg-white rounded-full p-2 text-gray-700 hover:text-gray-900 shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 z-10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <img id="design-modal-image" src="" alt="Design Preview" class="w-full h-auto max-h-[80vh] object-contain rounded">
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast-notification" class="toast fixed bottom-5 right-5 bg-green-600 text-white py-3 px-6 rounded-lg shadow-lg flex items-center z-[100]">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
        <span id="toast-message">Item added to cart!</span>
    </div>

    <!-- Firebase SDK and JavaScript Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, runTransaction, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- CONFIGURATION ---
            const whatsAppNumber = '918210746035'; // Your WhatsApp number
            const cartStorageKey = 'lafandar_cart';
            const orderStorageKey = 'lafandar_last_order';
            const visitorDetailsKey = 'lafandar_visitor_details';
            const firebaseConfig = {
                apiKey: "AIzaSyAJsKAoQYNmVeAbAREpTRnpnvKyA9fauow",
                authDomain: "lafandar-catalogue.firebaseapp.com",
                projectId: "lafandar-catalogue",
                storageBucket: "lafandar-catalogue.firebasestorage.app",
                messagingSenderId: "776396917041",
                appId: "1:776396917041:web:2f40680e2312ed09478810"
            };
            const appId = 'lafandar-app';
            const productsCollectionPath = `/artifacts/${appId}/public/data/products`;
            const visitorsCollectionPath = `/artifacts/${appId}/public/data/visitors`;


            // --- FIREBASE INITIALIZATION ---
            let app;
            let db;
            let auth;
            
            try {
                 app = initializeApp(firebaseConfig);
                 db = getFirestore(app);
                 auth = getAuth(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('grid-loader').innerHTML = '<p class="text-red-500">Could not connect to database. Please check configuration.</p>';
                return;
            }
           
            // --- STATE ---
            let products = [];
            const savedCart = localStorage.getItem(cartStorageKey);
            let cart = savedCart ? JSON.parse(savedCart) : [];
            let isAuthReady = false;

            // --- AUTH LISTENER ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    isAuthReady = true;
                } else {
                    signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
                }
            });

            // --- DOM ELEMENTS ---
            const mainContent = document.getElementById('main-content');
            const welcomeModal = document.getElementById('welcome-modal');
            const welcomeForm = document.getElementById('welcome-form');
            const productGrid = document.getElementById('product-grid');
            const gridLoader = document.getElementById('grid-loader');
            const cartButton = document.getElementById('cart-button');
            const viewOrderBtn = document.getElementById('view-order-btn');
            const customerNameDisplay = document.getElementById('customer-name-display');
            const cartModal = document.getElementById('cart-modal');
            const cartPanel = document.getElementById('cart-panel');
            const closeCartBtn = document.getElementById('close-cart-btn');
            const cartCountEl = document.getElementById('cart-count');
            const cartItemsContainer = document.getElementById('cart-items-container');
            const cartSubtotalEl = document.getElementById('cart-subtotal');
            const emptyCartMessage = document.getElementById('empty-cart-message');
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            const designModal = document.getElementById('design-modal');
            const designModalContent = document.getElementById('design-modal-content');
            const designModalImage = document.getElementById('design-modal-image');
            const closeDesignBtn = document.getElementById('close-design-btn');
            const whatsappBtn = document.getElementById('whatsapp-btn');
            const orderSummaryModal = document.getElementById('order-summary-modal');
            const closeSummaryBtn = document.getElementById('close-summary-btn');
            const confirmOrderBtn = document.getElementById('confirm-order-btn');
            const summaryItemsContainer = document.getElementById('summary-items-container');
            const summaryTotalItems = document.getElementById('summary-total-items');
            const summaryGrandTotal = document.getElementById('summary-grand-total');
            const summaryCustomerDetails = document.getElementById('summary-customer-details');


            // --- FETCH & RENDER PRODUCTS FROM FIREBASE ---
            onSnapshot(collection(db, productsCollectionPath), (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts();
            });

            // --- HELPERS ---
            const generateSizeHTML = (product, colorData, cart) => {
                const availableSizes = colorData.stockBySize ? Object.keys(colorData.stockBySize).sort() : [];
                
                if(availableSizes.length === 0){
                    return `<p class="text-sm text-gray-500 text-center col-span-full py-4">No sizes available for this color.</p>`;
                }

                return availableSizes.map(size => {
                    const totalStock = colorData.stockBySize?.[size] || 0;
                    const allowBackorder = product.allowBackorder === true;
                    const backorderMsg = product.backorderMessage || "Backorder Available (10-15 days)";
                    
                    // Count only 'instock' type items for the remaining stock calculation
                    const instockItem = cart.find(item => 
                        item.productId === product.id &&
                        item.color === colorData.name &&
                        item.size === size &&
                        item.stockStatus === 'instock'
                    );
                    const quantityInCart = instockItem ? instockItem.quantity : 0;
                    const remainingStock = totalStock - quantityInCart;
                    
                    // Determine status
                    const isOutOfStock = remainingStock <= 0;
                    const canOrder = !isOutOfStock || allowBackorder;
                    
                    // Determine display text and style
                    let stockDisplayText = `${remainingStock} left`;
                    let stockClass = "text-gray-500";
                    
                    if (isOutOfStock) {
                        if (allowBackorder) {
                            stockDisplayText = backorderMsg;
                            stockClass = "text-orange-600 font-bold text-[10px] leading-tight";
                        } else {
                            stockDisplayText = "Out of Stock";
                            stockClass = "text-red-500 font-semibold";
                        }
                    }

                    // For input max: if backorder permitted, allow high number (e.g. 100), otherwise restrict to remaining stock
                    const inputMax = allowBackorder ? 100 : Math.max(0, remainingStock);

                    return `
                        <div>
                            <div class="size-container grid grid-cols-3 items-center gap-2">
                                <button class="size-btn border-2 border-gray-300 rounded-md py-2 font-semibold text-sm transition-colors text-center ${!canOrder ? 'bg-gray-100 text-gray-400 cursor-not-allowed line-through' : 'hover:bg-gray-200'}"
                                        data-size="${size}" ${!canOrder ? 'disabled' : ''}>
                                    ${size}
                                </button>
                                <span class="stock-display text-xs text-center ${stockClass}">
                                    ${stockDisplayText}
                                </span>
                                <input type="number" min="0" max="${inputMax}" value="0" class="quantity-input border-gray-300 rounded-md text-center text-sm p-1" placeholder="0" ${!canOrder ? 'disabled' : ''}>
                            </div>
                            <p class="stock-error-message text-red-600 text-xs text-center mt-1"></p>
                        </div>
                    `;
                }).join('');
            };

            // --- RENDER PRODUCTS ---
            const renderProducts = () => {
                if (gridLoader) {
                    gridLoader.remove();
                }
                productGrid.innerHTML = '';
                if (products.length === 0) {
                     productGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">No products found. The owner might be adding new stock!</p>`;
                     return;
                }
                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'bg-white rounded-lg shadow-lg overflow-hidden flex flex-col';
                    productCard.dataset.productId = product.id;
                    const firstColor = product.colors?.[0];

                    if (!firstColor) return; // Skip rendering if a product has no colors

                    const colorSwatches = product.colors.map((color, index) => `
                        <button class="color-swatch w-8 h-8 rounded-full border-2 border-white ring-1 ring-gray-300 ${index === 0 ? 'selected' : ''}" 
                                style="background-color: ${color.hex};" 
                                data-color="${color.name}"
                                data-image="${color.image}"
                                title="${color.name}">
                        </button>
                    `).join('');

                    const sizeButtons = generateSizeHTML(product, firstColor, cart);
                    
                    const preloaderImages = product.colors.map(color => `<img src="${color.image}" alt="">`).join('');

                    productCard.innerHTML = `
                        <div class="relative h-96">
                            <img src="${firstColor.image}" alt="${product.name}" class="product-image w-full h-full object-cover">
                            <div class="image-preloader">${preloaderImages}</div>
                        </div>
                        <div class="p-4 sm:p-6 flex-grow flex flex-col">
                            <h2 class="text-xl font-bold mb-2">${product.name}</h2>
                            <p class="text-gray-600 text-sm mb-4 flex-grow">${product.description}</p>
                            
                            <div class="mb-4">
                                <h3 class="text-sm font-semibold mb-2 text-gray-700">Color</h3>
                                <div class="flex items-center space-x-2">
                                    ${colorSwatches}
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <div class="grid grid-cols-3 items-baseline mb-2 text-center">
                                    <h3 class="text-sm font-semibold text-gray-700">Size</h3>
                                    <h3 class="text-sm font-semibold text-gray-700">Stock</h3>
                                    <h3 class="text-sm font-semibold text-gray-700">Quantity</h3>
                                </div>
                                <div class="size-list flex flex-col gap-2">
                                    ${sizeButtons}
                                </div>
                            </div>

                            <div class="design-section hidden mb-6">
                                <h3 class="text-sm font-semibold mb-2 text-gray-700">Choose a Design</h3>
                                <div class="design-options flex flex-wrap gap-3">
                                    <!-- Designs will be injected here -->
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center mt-auto pt-4 border-t">
                                <span class="text-2xl font-bold">₹${product.price}</span>
                                <button class="add-to-cart-btn bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors transform hover:scale-105">
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    `;
                    productGrid.appendChild(productCard);
                    
                    const firstColorData = product.colors[0];
                    const designSection = productCard.querySelector('.design-section');
                    const designOptionsContainer = productCard.querySelector('.design-options');
                    if (firstColorData && firstColorData.designs && firstColorData.designs.length > 0) {
                        designOptionsContainer.innerHTML = firstColorData.designs.map(design => `
                            <button class="design-option p-1 rounded-md text-center" data-design-id="${design.id}" data-design-name="${design.name}">
                                <div class="relative">
                                    <img src="${design.image}" alt="${design.name}" class="w-16 h-16 object-cover rounded-sm pointer-events-none mx-auto transition-all duration-200">
                                    <div class="selected-checkmark absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                                    </div>
                                </div>
                                <span class="text-xs text-gray-600 pointer-events-none block mt-1">${design.name}</span>
                            </button>
                        `).join('');
                        designSection.classList.remove('hidden');
                    }
                });
            };

            // --- EVENT LISTENERS ---
            productGrid.addEventListener('input', (e) => {
                if (e.target.classList.contains('quantity-input')) {
                    const input = e.target;
                    const value = parseInt(input.value, 10) || 0;
                    const max = parseInt(input.max, 10);
                    const sizeContainer = input.closest('.size-container').parentElement;
                    const errorEl = sizeContainer.querySelector('.stock-error-message');
                    const sizeBtn = sizeContainer.querySelector('.size-btn');

                    if (value > max) {
                        input.classList.add('border-red-500', 'ring', 'ring-red-200');
                        errorEl.textContent = `Limit exceeded!`;
                        errorEl.classList.add('show');
                    } else {
                        input.classList.remove('border-red-500', 'ring', 'ring-red-200');
                        errorEl.classList.remove('show');
                    }
                    
                    if (value > 0) {
                        sizeBtn.classList.add('selected');
                    } else {
                        sizeBtn.classList.remove('selected');
                    }
                }
            });

            productGrid.addEventListener('click', (e) => {
                const card = e.target.closest('.bg-white');
                if (!card) return;
                const productId = card.dataset.productId;
                const product = products.find(p => p.id === productId);

                // Handle color selection
                if (e.target.classList.contains('color-swatch')) {
                    const newImage = e.target.dataset.image;
                    const productImage = card.querySelector('.product-image');
                    
                    productImage.src = newImage;

                    card.querySelectorAll('.color-swatch').forEach(swatch => swatch.classList.remove('selected'));
                    e.target.classList.add('selected');

                    const selectedColorName = e.target.dataset.color;
                    const selectedColorData = product.colors.find(c => c.name === selectedColorName);

                    card.querySelector('.size-list').innerHTML = generateSizeHTML(product, selectedColorData, cart);

                    const designSection = card.querySelector('.design-section');
                    const designOptionsContainer = card.querySelector('.design-options');
                    card.querySelectorAll('.design-option').forEach(btn => btn.classList.remove('selected'));

                    if (selectedColorData && selectedColorData.designs && selectedColorData.designs.length > 0) {
                        designOptionsContainer.innerHTML = selectedColorData.designs.map(design => `
                             <button class="design-option p-1 rounded-md text-center" data-design-id="${design.id}" data-design-name="${design.name}">
                                <div class="relative">
                                    <img src="${design.image}" alt="${design.name}" class="w-16 h-16 object-cover rounded-sm pointer-events-none mx-auto transition-all duration-200">
                                    <div class="selected-checkmark absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                                    </div>
                                </div>
                                <span class="text-xs text-gray-600 pointer-events-none block mt-1">${design.name}</span>
                            </button>
                        `).join('');
                        designSection.classList.remove('hidden');
                    } else {
                        designOptionsContainer.innerHTML = '';
                        designSection.classList.add('hidden');
                    }
                }

                // Handle size selection
                if (e.target.classList.contains('size-btn')) {
                    e.target.classList.toggle('selected');
                }

                // Handle design selection
                if (e.target.closest('.design-option')) {
                    const designButton = e.target.closest('.design-option');
                    const designImageEl = designButton.querySelector('img');

                    if(designImageEl) {
                        openDesignModal(designImageEl.src);
                    }
                    
                    if(designButton.classList.contains('selected')){
                         designButton.classList.remove('selected');
                    } else {
                        card.querySelectorAll('.design-option').forEach(btn => btn.classList.remove('selected'));
                        designButton.classList.add('selected');
                    }
                }
                
                // Handle Add to Cart
                if (e.target.classList.contains('add-to-cart-btn')) {
                    const selectedColorEl = card.querySelector('.color-swatch.selected');
                    const selectedSizeNodes = card.querySelectorAll('.size-btn.selected');

                    if (!selectedColorEl || selectedSizeNodes.length === 0) {
                        showToast('Please select a color and at least one size.', true);
                        return;
                    }
                    
                    const designSection = card.querySelector('.design-section');
                    let itemDetails = {};

                    if (!designSection.classList.contains('hidden')) {
                        const selectedDesignEl = card.querySelector('.design-option.selected');
                        if (!selectedDesignEl) {
                            showToast('Please select a design.', true);
                            return;
                        }
                        itemDetails.designId = selectedDesignEl.dataset.designId;
                        itemDetails.designName = selectedDesignEl.dataset.designName;
                    }

                    let totalQuantityAdded = 0;
                    let stockError = false;
                    const selectedColorName = selectedColorEl.dataset.color;
                    const selectedColorData = product.colors.find(c => c.name === selectedColorName);

                    selectedSizeNodes.forEach(sizeNode => {
                        if (stockError) return;
                        const size = sizeNode.dataset.size;
                        const quantityInput = sizeNode.parentElement.parentElement.querySelector('.quantity-input');
                        const quantityToAdd = parseInt(quantityInput.value, 10) || 0;
                        
                        if (quantityToAdd <= 0) return;

                        const totalStock = selectedColorData.stockBySize?.[size] || 0;
                        
                        // Check existing cart quantity for just IN STOCK items
                        const baseId = `${productId}-${selectedColorName}-${size}-${itemDetails.designId || 'no-design'}`;
                        const existingInstockItem = cart.find(item => item.id === `${baseId}-instock`);
                        const currentInstockQtyInCart = existingInstockItem ? existingInstockItem.quantity : 0;
                        
                        const remainingRealStock = Math.max(0, totalStock - currentInstockQtyInCart);
                        
                        // Strict check ONLY if backorder is disabled
                        if (product.allowBackorder !== true && quantityToAdd > remainingRealStock) {
                            showToast(`Only ${remainingRealStock} left for size ${size}.`, true);
                            stockError = true;
                            return;
                        }

                        // Split logic: Determine how many go to 'instock' vs 'backorder'
                        let qtyForInstock = 0;
                        let qtyForBackorder = 0;

                        if (quantityToAdd <= remainingRealStock) {
                            qtyForInstock = quantityToAdd;
                        } else {
                            qtyForInstock = remainingRealStock; // Take whatever is left
                            qtyForBackorder = quantityToAdd - remainingRealStock; // Put rest in backorder
                        }

                        const itemBase = {
                            productId: productId,
                            name: product.name,
                            price: product.price,
                            color: selectedColorName,
                            size: size,
                            image: selectedColorEl.dataset.image,
                            ...(itemDetails.designId && { design: { name: itemDetails.designName } })
                        };

                        if (qtyForInstock > 0) {
                            addToCart({
                                ...itemBase,
                                id: `${baseId}-instock`,
                                quantity: qtyForInstock,
                                stockStatus: 'instock'
                            });
                        }

                        if (qtyForBackorder > 0) {
                            addToCart({
                                ...itemBase,
                                id: `${baseId}-backorder`,
                                quantity: qtyForBackorder,
                                stockStatus: 'backorder'
                            });
                        }

                        totalQuantityAdded += quantityToAdd;
                    });

                    if (totalQuantityAdded > 0 && !stockError) {
                        showToast(`${totalQuantityAdded} item${totalQuantityAdded > 1 ? 's' : ''} added to cart!`);
                    }
                }
            });

            // --- CART LOGIC ---
            const addToCart = (item) => {
                const existingItem = cart.find(cartItem => cartItem.id === item.id);
                if (existingItem) {
                    existingItem.quantity += item.quantity;
                } else {
                    cart.push(item);
                }
                updateCart();
            };

            const updateCart = () => {
                localStorage.setItem(cartStorageKey, JSON.stringify(cart));
                renderProducts(); // Re-render to update stock display
                renderCartItems();
                updateCartCount();
                updateCartSubtotal();
                whatsappBtn.disabled = cart.length === 0;
                updateViewOrderButton();
            };

            const renderCartItems = () => {
                cartItemsContainer.innerHTML = '';
                if (cart.length === 0) {
                    emptyCartMessage.style.display = 'block';
                } else {
                    emptyCartMessage.style.display = 'none';
                    cart.forEach(item => {
                        // Determine Message based on stored stockStatus
                        let statusMsg = '';
                        const product = products.find(p => p.id === item.productId);
                        
                        if (item.stockStatus === 'backorder' && product) {
                             const msg = product.backorderMessage || "Delivery in 10-15 days";
                             statusMsg = `<p class="text-[10px] text-orange-600 font-bold mt-1 bg-orange-50 inline-block px-2 py-0.5 rounded border border-orange-200">⚠️ ${msg}</p>`;
                        } else if (item.stockStatus === 'instock') {
                            statusMsg = `<p class="text-[10px] text-green-600 font-bold mt-1">✓ In Stock & Ready to Ship</p>`;
                        }

                        const cartItemEl = document.createElement('div');
                        cartItemEl.className = 'flex items-start sm:items-center space-x-4 mb-5 pb-5 border-b last:border-b-0 cart-item-enter';
                        cartItemEl.innerHTML = `
                            <img src="${item.image}" alt="${item.name}" class="w-20 h-24 object-cover rounded-md">
                            <div class="flex-grow">
                                <p class="font-semibold">${item.name}</p>
                                <p class="text-sm text-gray-500">Color: ${item.color}</p>
                                <p class="text-sm text-gray-500">Size: ${item.size}</p>
                                ${item.design ? `<p class="text-sm text-gray-500 font-medium">Design: ${item.design.name}</p>` : ''}
                                <p class="font-bold mt-1 text-base">₹${item.price}</p>
                                ${statusMsg}
                            </div>
                            <div class="text-right flex flex-col items-end">
                                <div class="flex items-center border rounded-md">
                                    <button class="px-2 py-1 text-gray-600 hover:bg-gray-100" data-itemid="${item.id}" data-action="decrease">-</button>
                                    <span class="px-3">${item.quantity}</span>
                                    <button class="px-2 py-1 text-gray-600 hover:bg-gray-100" data-itemid="${item.id}" data-action="increase">+</button>
                                </div>
                                <button class="text-xs text-red-500 hover:underline mt-2" data-itemid="${item.id}" data-action="remove">Remove</button>
                            </div>
                        `;
                        cartItemsContainer.appendChild(cartItemEl);
                        requestAnimationFrame(() => cartItemEl.classList.add('cart-item-enter-active'));
                    });
                }
            };
            
            cartItemsContainer.addEventListener('click', (e) => {
                if(e.target.tagName !== 'BUTTON') return;
                const itemId = e.target.dataset.itemid;
                const action = e.target.dataset.action;
                const itemIndex = cart.findIndex(item => item.id === itemId);
                if (itemIndex === -1) return;

                const currentItem = cart[itemIndex];
                const product = products.find(p => p.id === currentItem.productId);
                
                // Safety check if product exists (it should)
                if(!product) {
                    cart.splice(itemIndex, 1);
                    updateCart();
                    return;
                }

                if (action === 'increase') {
                    if (currentItem.stockStatus === 'instock') {
                         const colorData = product.colors.find(c => c.name === currentItem.color);
                         const totalStock = colorData.stockBySize?.[currentItem.size] || 0;
                         
                         // For 'instock' items, we MUST respect physical stock limits
                         // Note: We don't subtract backorder quantity here because backorder items are virtual/negative stock
                         if (currentItem.quantity >= totalStock) {
                            showToast(`No more physical stock available. Add more as Backorder via main page.`, true);
                            return; 
                         }
                         currentItem.quantity++;
                    } else {
                         // Backorder items can be increased freely (up to a reasonable limit like 100)
                         currentItem.quantity++;
                    }
                } else if (action === 'decrease') {
                    currentItem.quantity--;
                    if (currentItem.quantity <= 0) cart.splice(itemIndex, 1);
                } else if (action === 'remove') {
                    cart.splice(itemIndex, 1);
                }
                
                updateCart();
            });

            const updateCartCount = () => {
                cartCountEl.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            };

            const updateCartSubtotal = () => {
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                cartSubtotalEl.textContent = `₹${subtotal.toFixed(2)}`;
            };

            const openCart = () => {
                cartModal.classList.remove('hidden');
                setTimeout(() => cartPanel.classList.remove('translate-x-full'), 10);
            };

            const closeCart = () => {
                cartPanel.classList.add('translate-x-full');
                setTimeout(() => cartModal.classList.add('hidden'), 300);
            };
            
            cartButton.addEventListener('click', openCart);
            closeCartBtn.addEventListener('click', closeCart);
            cartModal.addEventListener('click', (e) => e.target === cartModal && closeCart());

            // --- CUSTOMER DETAILS & ORDER LOGIC ---
            const processOrder = async () => {
                if (cart.length === 0) return;
                
                whatsappBtn.disabled = true;
                whatsappBtn.innerHTML = `<span>Processing...</span>`;

                try {
                    await runTransaction(db, async (transaction) => {
                        const productsInCart = {};
                        cart.forEach(item => {
                            if (!productsInCart[item.productId]) productsInCart[item.productId] = [];
                            productsInCart[item.productId].push(item);
                        });

                        const productRefs = {}, productDocs = {};
                        for (const productId in productsInCart) {
                            const docRef = doc(db, productsCollectionPath, productId);
                            productRefs[productId] = docRef;
                            const productDoc = await transaction.get(docRef);
                            if (!productDoc.exists()) throw new Error(`Product ${productId} not found!`);
                            productDocs[productId] = productDoc.data();
                        }

                        for (const productId in productsInCart) {
                            const items = productsInCart[productId];
                            const productData = productDocs[productId];
                            items.forEach(item => {
                                const colorIndex = productData.colors.findIndex(c => c.name === item.color);
                                if (colorIndex === -1) throw new Error(`Color ${item.color} not found.`);
                                const currentStock = productData.colors[colorIndex].stockBySize[item.size];
                                if (currentStock === undefined) throw new Error(`Size ${item.size} not found.`);
                                
                                const newStock = currentStock - item.quantity;
                                
                                // BLOCK Order only if negative stock AND Backorder Disabled
                                if (productData.allowBackorder !== true && newStock < 0) {
                                     throw new Error(`Not enough stock for ${item.name} (${item.size}). Only ${currentStock} left.`);
                                }
                                
                                productData.colors[colorIndex].stockBySize[item.size] = newStock;
                            });
                            transaction.update(productRefs[productId], { colors: productData.colors });
                        }
                    });
                    
                    localStorage.setItem(orderStorageKey, JSON.stringify(cart));
                    cart = [];
                    updateCart();
                    closeCart();
                    setTimeout(openSummary, 300);

                } catch (e) {
                    console.error("Order failed:", e);
                    showToast(e.message || "Order failed. Stock may have changed.", true);
                } finally {
                    whatsappBtn.disabled = false;
                    whatsappBtn.innerHTML = `<span>Review & Order</span>`;
                }
            };

            whatsappBtn.addEventListener('click', async () => {
               await processOrder();
            });

            const renderOrderSummary = () => {
                const lastOrder = JSON.parse(localStorage.getItem(orderStorageKey));
                const visitor = JSON.parse(localStorage.getItem(visitorDetailsKey));

                if (visitor) {
                    summaryCustomerDetails.innerHTML = `
                        <h4 class="font-semibold text-lg mb-2">Customer Details</h4>
                        <p class="text-gray-700"><span class="font-medium">Name:</span> ${visitor.name}</p>
                        <p class="text-gray-700"><span class="font-medium">Mobile:</span> ${visitor.mobile}</p>
                    `;
                } else {
                    summaryCustomerDetails.innerHTML = '';
                }

                if (!lastOrder || lastOrder.length === 0) {
                    summaryItemsContainer.innerHTML = '<p class="text-gray-500">No order details found.</p>';
                    return;
                };

                summaryItemsContainer.innerHTML = '';
                lastOrder.forEach(item => {
                    let typeLabel = item.stockStatus === 'backorder' ? '(Backorder)' : '';
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between items-start';
                    itemEl.innerHTML = `
                        <div>
                            <p class="font-semibold">${item.name} <span class="text-xs font-normal text-gray-500">${typeLabel}</span></p>
                            <p class="text-sm text-gray-600">(${item.color}, ${item.size}${item.design ? ', ' + item.design.name : ''})</p>
                            <p class="text-sm text-gray-500">${item.quantity} x ₹${item.price}</p>
                        </div>
                        <p class="font-semibold text-gray-800">₹${(item.quantity * item.price).toFixed(2)}</p>
                    `;
                    summaryItemsContainer.appendChild(itemEl);
                });
                
                const totalItems = lastOrder.reduce((sum, item) => sum + item.quantity, 0);
                const subtotal = lastOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                summaryTotalItems.textContent = totalItems;
                summaryGrandTotal.textContent = `₹${subtotal.toFixed(2)}`;
            };

            const openSummary = () => {
                renderOrderSummary();
                orderSummaryModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            };

            const closeSummary = () => {
                orderSummaryModal.classList.add('hidden');
                document.body.style.overflow = '';
            };
            
            const updateViewOrderButton = () => {
                const lastOrder = localStorage.getItem(orderStorageKey);
                if (lastOrder && JSON.parse(lastOrder).length > 0) {
                    viewOrderBtn.classList.remove('hidden');
                } else {
                    viewOrderBtn.classList.add('hidden');
                }
            };
            
            const updateCustomerDisplay = () => {
                 const savedVisitor = localStorage.getItem(visitorDetailsKey);
                if (savedVisitor) {
                    const visitor = JSON.parse(savedVisitor);
                    customerNameDisplay.textContent = `Hi, ${visitor.name.split(' ')[0]}`;
                    customerNameDisplay.classList.remove('hidden');
                }
            };

            viewOrderBtn.addEventListener('click', openSummary);
            closeSummaryBtn.addEventListener('click', closeSummary);

            confirmOrderBtn.addEventListener('click', () => {
                const lastOrder = JSON.parse(localStorage.getItem(orderStorageKey));
                const visitor = JSON.parse(localStorage.getItem(visitorDetailsKey));
                if (!lastOrder || lastOrder.length === 0) return;
                
                let message = `*New Order for LAFANDAR*\n\n`;
                if (visitor) {
                    message += `*Customer Details:*\n`;
                    message += `*Name:* ${visitor.name}\n`;
                    message += `*Mobile:* ${visitor.mobile}\n\n`;
                }
                
                message += `*Order Summary:*\n\n`;
                lastOrder.forEach((item, index) => {
                    const typeLabel = item.stockStatus === 'backorder' ? ' (Backorder)' : '';
                    message += `*${index + 1}. ${item.name}${typeLabel}*\n   - Color: ${item.color}\n   - Size: ${item.size}\n`;
                    if (item.design) message += `   - Design: ${item.design.name}\n`;
                    message += `   - Quantity: ${item.quantity}\n   - Price: ₹${item.price}\n\n`;
                });
                const subtotal = lastOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                message += `--------------------\n*Total Items:* ${lastOrder.reduce((sum, item) => sum + item.quantity, 0)}\n*Grand Total:* ₹${subtotal.toFixed(2)}\n\nPlease confirm my order. Thank you!`;
                window.open(`https://wa.me/${whatsAppNumber}?text=${encodeURIComponent(message)}`, '_blank');
            });

            // --- DESIGN PREVIEW MODAL LOGIC ---
            const openDesignModal = (imageUrl) => {
                designModalImage.src = imageUrl;
                designModal.classList.remove('hidden');
                designModal.classList.add('flex');
            };
            const closeDesignModal = () => {
                designModal.classList.add('hidden');
                designModal.classList.remove('flex');
            };
            closeDesignBtn.addEventListener('click', closeDesignModal);
            designModal.addEventListener('click', (e) => e.target === designModal && closeDesignModal());
            document.addEventListener('keydown', (e) => e.key === 'Escape' && !designModal.classList.contains('hidden') && closeDesignModal());

            // --- TOAST NOTIFICATION ---
            let toastTimer;
            const showToast = (message, isError = false) => {
                toastMessage.textContent = message;
                toast.className = `toast fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg flex items-center z-[100] ${isError ? 'bg-red-600' : 'bg-green-600'}`;
                toast.classList.add('show');
                clearTimeout(toastTimer);
                toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
            };

            // --- INITIALIZATION & WELCOME GATE ---
            const initializeAppLogic = () => {
                const savedVisitor = localStorage.getItem(visitorDetailsKey);
                if (savedVisitor) {
                    welcomeModal.style.display = 'none';
                    mainContent.style.display = 'block';
                    updateCustomerDisplay();
                    updateCart();
                } else {
                    welcomeModal.style.display = 'flex';
                }
            };

            welcomeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const visitorDetails = {
                    name: document.getElementById('welcome-name').value,
                    mobile: document.getElementById('welcome-mobile').value,
                };
                localStorage.setItem(visitorDetailsKey, JSON.stringify(visitorDetails));

                try {
                    const visitorId = `visitor_${Date.now()}`;
                    await setDoc(doc(db, visitorsCollectionPath, visitorId), {
                        ...visitorDetails,
                        timestamp: new Date()
                    });
                } catch (error) {
                    console.error("Failed to save visitor data to Firestore:", error);
                }

                initializeAppLogic();
            });
            
            initializeAppLogic();
        });
    </script>
</body>
</html>
