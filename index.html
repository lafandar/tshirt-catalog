<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAFANDAR | T-Shirt Catalogue</title>
    
    <!-- Official Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS for animations and styling -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .color-swatch {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        .color-swatch.selected {
            box-shadow: 0 0 0 3px #1e40af; /* A strong blue ring */
        }
        .size-btn.selected {
            background-color: #1e3a8a; /* Darker blue */
            color: white;
            border-color: #1e3a8a;
        }
        .product-image {
            transition: opacity 0.3s ease-in-out;
        }
        .fade-out {
            opacity: 0;
        }
        .toast {
            visibility: hidden;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease-in-out;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
        .cart-item-enter {
            opacity: 0;
            transform: translateX(-20px);
            transition: all 0.3s ease-out;
        }
        .cart-item-enter-active {
            opacity: 1;
            transform: translateX(0);
        }
        .design-option {
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
        }
        .design-option:hover {
            transform: scale(1.05);
        }
        .design-option .check-overlay {
            transition: opacity 0.2s ease-in-out;
        }
        .design-option.selected .check-overlay {
            opacity: 1;
        }
        .design-option.selected {
            transform: scale(1.05);
        }
        #design-modal-content {
            transform: scale(0.95);
            transition: transform 0.2s ease-out;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl sm:text-3xl font-bold text-gray-900 tracking-tight">
                LAFANDAR CATALOGUE
            </h1>
            <button id="cart-button" class="relative">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-600 hover:text-gray-900 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-blue-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold">0</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="product-grid" class="container mx-auto px-4 sm:px-6 py-8 sm:py-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-10">
        <div id="grid-loader" class="col-span-full flex flex-col items-center justify-center min-h-[50vh]">
            <div class="loader"></div>
            <p class="mt-4 text-gray-500">Loading Latest Collection...</p>
        </div>
    </main>
    
    <!-- Shopping Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-end">
        <div id="cart-panel" class="w-full max-w-md bg-white h-full shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <!-- Cart Header -->
                <div class="flex justify-between items-center p-4 sm:p-6 border-b">
                    <h2 class="text-xl sm:text-2xl font-semibold">Your Cart</h2>
                    <button id="close-cart-btn" class="text-gray-500 hover:text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <!-- Cart Items -->
                <div id="cart-items-container" class="flex-grow p-4 sm:p-6 overflow-y-auto">
                    <!-- Cart items will be injected here -->
                    <div id="empty-cart-message" class="text-center text-gray-500 mt-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                        <p class="mt-4 text-lg">Your cart is empty.</p>
                        <p class="text-sm">Looks like you haven't added anything yet.</p>
                    </div>
                </div>

                <!-- Cart Footer -->
                <div class="p-4 sm:p-6 border-t bg-gray-50">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-medium">Subtotal</span>
                        <span id="cart-subtotal" class="text-xl font-bold">â‚¹0.00</span>
                    </div>
                    <button id="whatsapp-btn" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors disabled:bg-gray-400 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413 0 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.687-1.475L.057 24zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 4.315 1.731 6.086l.287.468-1.911 5.462 5.547-1.83z"/></svg>
                        <span>Order on WhatsApp</span>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Design Preview Modal -->
    <div id="design-modal" class="fixed inset-0 bg-black bg-opacity-75 z-[60] hidden items-center justify-center p-4" role="dialog" aria-modal="true">
        <div id="design-modal-content" class="bg-white rounded-lg shadow-2xl p-4 relative max-w-lg w-full">
            <button id="close-design-btn" class="absolute -top-4 -right-4 bg-white rounded-full p-2 text-gray-700 hover:text-gray-900 shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 z-10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin-round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <img id="design-modal-image" src="" alt="Design Preview" class="w-full h-auto max-h-[80vh] object-contain rounded">
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast-notification" class="toast fixed bottom-5 right-5 bg-green-600 text-white py-3 px-6 rounded-lg shadow-lg flex items-center z-[100]">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
        <span id="toast-message">Item added to cart!</span>
    </div>

    <!-- Firebase SDK and JavaScript Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- CONFIGURATION ---
            const whatsAppNumber = '918210746035'; // Your WhatsApp number
            const cartStorageKey = 'lafandar_cart';
            const firebaseConfig = {
                apiKey: "AIzaSyAJsKAoQYNmVeAbAREpTRnpnvKyA9fauow",
                authDomain: "lafandar-catalogue.firebaseapp.com",
                projectId: "lafandar-catalogue",
                storageBucket: "lafandar-catalogue.firebasestorage.app",
                messagingSenderId: "776396917041",
                appId: "1:776396917041:web:2f40680e2312ed09478810"
            };
            const appId = 'lafandar-app';
            const productsCollectionPath = `/artifacts/${appId}/public/data/products`;

            // --- FIREBASE INITIALIZATION ---
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            // --- STATE ---
            let products = [];
            const savedCart = localStorage.getItem(cartStorageKey);
            let cart = savedCart ? JSON.parse(savedCart) : [];

            // --- DOM ELEMENTS ---
            const productGrid = document.getElementById('product-grid');
            const gridLoader = document.getElementById('grid-loader');
            const cartButton = document.getElementById('cart-button');
            const cartModal = document.getElementById('cart-modal');
            const cartPanel = document.getElementById('cart-panel');
            const closeCartBtn = document.getElementById('close-cart-btn');
            const cartCountEl = document.getElementById('cart-count');
            const cartItemsContainer = document.getElementById('cart-items-container');
            const cartSubtotalEl = document.getElementById('cart-subtotal');
            const emptyCartMessage = document.getElementById('empty-cart-message');
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            const designModal = document.getElementById('design-modal');
            const designModalContent = document.getElementById('design-modal-content');
            const designModalImage = document.getElementById('design-modal-image');
            const closeDesignBtn = document.getElementById('close-design-btn');
            const whatsappBtn = document.getElementById('whatsapp-btn');

            onAuthStateChanged(auth, user => {
                if (user) {
                    onSnapshot(collection(db, productsCollectionPath), (snapshot) => {
                        products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderProducts();
                        updateStockDisplay(); // Update stock based on cart after products load
                    });
                } else {
                    signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
                }
            });


            // --- HELPERS ---
            const generateSizeHTML = (product, colorData) => {
                return product.sizes.map(size => {
                    const stock = colorData.stockBySize?.[size] !== undefined ? colorData.stockBySize[size] : 0;
                    return `
                        <div class="size-container flex items-center justify-between gap-2">
                            <button class="size-btn border-2 border-gray-300 rounded-md py-2 font-semibold text-sm transition-colors w-14 text-center hover:bg-gray-200"
                                    data-size="${size}">
                                ${size}
                            </button>
                            <span class="stock-display text-xs w-16 text-center text-gray-500" data-size="${size}">
                                ${stock} left
                            </span>
                            <input type="number" min="1" value="1" class="quantity-input w-16 border-gray-300 rounded-md text-center text-sm p-1" placeholder="Qty">
                        </div>
                    `;
                }).join('');
            };

            // --- RENDER PRODUCTS ---
            const renderProducts = () => {
                if (gridLoader) gridLoader.remove();
                productGrid.innerHTML = '';
                if (products.length === 0) {
                     productGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">No products found. The owner might be adding new stock!</p>`;
                     return;
                }
                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'bg-white rounded-lg shadow-lg overflow-hidden flex flex-col';
                    productCard.dataset.productId = product.id;

                    const colorSwatches = product.colors.map((color, index) => `
                        <button class="color-swatch w-8 h-8 rounded-full border-2 border-white ring-1 ring-gray-300 ${index === 0 ? 'selected' : ''}" 
                                style="background-color: ${color.hex};" 
                                data-color="${color.name}"
                                data-image="${color.image}"
                                title="${color.name}">
                        </button>
                    `).join('');

                    const sizeButtons = generateSizeHTML(product, product.colors[0]);

                    productCard.innerHTML = `
                        <div class="relative">
                            <img src="${product.colors[0].image}" alt="${product.name}" class="product-image w-full h-80 sm:h-96 object-cover">
                        </div>
                        <div class="p-4 sm:p-6 flex-grow flex flex-col">
                            <h2 class="text-xl font-bold mb-2">${product.name}</h2>
                            <p class="text-gray-600 text-sm mb-4 flex-grow">${product.description}</p>
                            
                            <div class="mb-4">
                                <h3 class="text-sm font-semibold mb-2 text-gray-700">Color</h3>
                                <div class="flex items-center space-x-2">
                                    ${colorSwatches}
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <div class="flex justify-between items-baseline mb-2 text-xs sm:text-sm">
                                    <h3 class="font-semibold text-gray-700 w-14 text-center">Size</h3>
                                    <h3 class="font-semibold text-gray-700 w-16 text-center">Stock</h3>
                                    <h3 class="font-semibold text-gray-700 w-16 text-center">Quantity</h3>
                                </div>
                                <div class="size-list flex flex-col gap-2">
                                    ${sizeButtons}
                                </div>
                            </div>

                            <div class="design-section hidden mb-6">
                                <h3 class="text-sm font-semibold mb-2 text-gray-700">Choose a Design</h3>
                                <div class="design-options flex flex-wrap gap-3"></div>
                            </div>
                            
                            <div class="flex justify-between items-center mt-auto">
                                <span class="text-2xl font-bold">â‚¹${product.price}</span>
                                <button class="add-to-cart-btn bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors transform hover:scale-105">
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    `;
                    productGrid.appendChild(productCard);
                    
                    const firstColorData = product.colors[0];
                    const designSection = productCard.querySelector('.design-section');
                    const designOptionsContainer = productCard.querySelector('.design-options');
                    if (firstColorData && firstColorData.designs && firstColorData.designs.length > 0) {
                        designOptionsContainer.innerHTML = firstColorData.designs.map(design => `
                            <button class="design-option relative p-1 border-2 border-transparent rounded-md text-center" data-design-id="${design.id}" data-design-name="${design.name}">
                                <div class="check-overlay pointer-events-none absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-md transition-opacity opacity-0">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                </div>
                                <img src="${design.image}" alt="${design.name}" class="w-16 h-16 object-cover rounded-sm pointer-events-none mx-auto">
                                <span class="text-xs text-gray-600 pointer-events-none block mt-1">${design.name}</span>
                            </button>
                        `).join('');
                        designSection.classList.remove('hidden');
                    }
                });
            };

            // --- DYNAMIC STOCK DISPLAY LOGIC ---
            const updateStockDisplay = () => {
                document.querySelectorAll('.bg-white[data-product-id]').forEach(card => {
                    const productId = card.dataset.productId;
                    const product = products.find(p => p.id === productId);
                    if (!product) return;

                    const selectedColorEl = card.querySelector('.color-swatch.selected');
                    if (!selectedColorEl) return;
                    
                    const selectedColorName = selectedColorEl.dataset.color;
                    const colorData = product.colors.find(c => c.name === selectedColorName);
                    if (!colorData) return;

                    card.querySelectorAll('.size-container').forEach(container => {
                        const size = container.querySelector('.size-btn').dataset.size;
                        const originalStock = colorData.stockBySize?.[size] || 0;
                        
                        const quantityInCart = cart.reduce((total, item) => {
                            if(item.productId === productId && item.color === selectedColorName && item.size === size) {
                                return total + item.quantity;
                            }
                            return total;
                        }, 0);
                        
                        const remainingStock = originalStock - quantityInCart;
                        
                        const stockDisplayEl = container.querySelector('.stock-display');
                        const sizeBtn = container.querySelector('.size-btn');
                        const quantityInput = container.querySelector('.quantity-input');

                        stockDisplayEl.textContent = remainingStock > 0 ? `${remainingStock} left` : 'Out of Stock';
                        stockDisplayEl.classList.toggle('text-red-500', remainingStock <= 0);
                        stockDisplayEl.classList.toggle('font-semibold', remainingStock <= 0);
                        
                        sizeBtn.disabled = remainingStock <= 0;
                        quantityInput.disabled = remainingStock <= 0;
                        quantityInput.max = remainingStock;
                        sizeBtn.classList.toggle('bg-gray-100', remainingStock <= 0);
                        sizeBtn.classList.toggle('text-gray-400', remainingStock <= 0);
                        sizeBtn.classList.toggle('cursor-not-allowed', remainingStock <= 0);
                    });
                });
            };

            // --- EVENT LISTENERS ---
            productGrid.addEventListener('click', (e) => {
                const card = e.target.closest('.bg-white');
                if (!card) return;
                const productId = card.dataset.productId;
                const product = products.find(p => p.id === productId);

                // Handle color selection
                if (e.target.classList.contains('color-swatch')) {
                    const newImage = e.target.dataset.image;
                    const productImage = card.querySelector('.product-image');
                    
                    productImage.classList.add('fade-out');
                    setTimeout(() => {
                        productImage.src = newImage;
                        productImage.classList.remove('fade-out');
                    }, 300);

                    card.querySelectorAll('.color-swatch').forEach(swatch => swatch.classList.remove('selected'));
                    e.target.classList.add('selected');

                    const selectedColorName = e.target.dataset.color;
                    const selectedColorData = product.colors.find(c => c.name === selectedColorName);

                    card.querySelector('.size-list').innerHTML = generateSizeHTML(product, selectedColorData);
                    updateStockDisplay(); // Update stock for new color

                    const designSection = card.querySelector('.design-section');
                    const designOptionsContainer = card.querySelector('.design-options');
                    card.querySelectorAll('.design-option').forEach(btn => btn.classList.remove('selected'));

                    if (selectedColorData && selectedColorData.designs && selectedColorData.designs.length > 0) {
                        designOptionsContainer.innerHTML = selectedColorData.designs.map(design => `
                            <button class="design-option relative p-1 border-2 border-transparent rounded-md text-center" data-design-id="${design.id}" data-design-name="${design.name}">
                                <div class="check-overlay pointer-events-none absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-md transition-opacity opacity-0">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                </div>
                                <img src="${design.image}" alt="${design.name}" class="w-16 h-16 object-cover rounded-sm pointer-events-none mx-auto">
                                <span class="text-xs text-gray-600 pointer-events-none block mt-1">${design.name}</span>
                            </button>
                        `).join('');
                        designSection.classList.remove('hidden');
                    } else {
                        designOptionsContainer.innerHTML = '';
                        designSection.classList.add('hidden');
                    }
                }

                // Handle size selection
                if (e.target.classList.contains('size-btn')) {
                    e.target.classList.toggle('selected');
                }

                // Handle design selection
                if (e.target.closest('.design-option')) {
                    const designButton = e.target.closest('.design-option');
                    const designImageEl = designButton.querySelector('img');
                    if(designImageEl) openDesignModal(designImageEl.src);
                    
                    card.querySelectorAll('.design-option').forEach(btn => btn.classList.remove('selected'));
                    designButton.classList.add('selected');
                }
                
                // Handle Add to Cart
                if (e.target.classList.contains('add-to-cart-btn')) {
                    const selectedColorEl = card.querySelector('.color-swatch.selected');
                    const selectedSizeNodes = card.querySelectorAll('.size-btn.selected');

                    if (!selectedColorEl || selectedSizeNodes.length === 0) {
                        showToast('Please select a color and at least one size.', true);
                        return;
                    }
                    
                    const designSection = card.querySelector('.design-section');
                    let itemDetails = {};

                    if (!designSection.classList.contains('hidden')) {
                        const selectedDesignEl = card.querySelector('.design-option.selected');
                        if (!selectedDesignEl) {
                            showToast('Please select a design.', true);
                            return;
                        }
                        itemDetails.designId = selectedDesignEl.dataset.designId;
                        itemDetails.designName = selectedDesignEl.dataset.designName;
                    }

                    let totalQuantityAdded = 0;
                    let stockError = false;

                    selectedSizeNodes.forEach(sizeNode => {
                        if (stockError) return;
                        const size = sizeNode.dataset.size;
                        const quantityInput = sizeNode.parentElement.querySelector('.quantity-input');
                        const quantity = parseInt(quantityInput.value, 10) || 1;
                        const availableStock = parseInt(quantityInput.max, 10);

                        if (quantity > availableStock) {
                            showToast(`Only ${availableStock} left for size ${size}. Please reduce quantity.`, true);
                            stockError = true;
                            return;
                        }

                        const item = {
                            id: `${productId}-${selectedColorEl.dataset.color}-${size}-${itemDetails.designId || ''}`,
                            productId: productId, name: product.name, price: product.price,
                            color: selectedColorEl.dataset.color, size: size,
                            image: selectedColorEl.dataset.image, quantity: quantity,
                            ...(itemDetails.designId && { design: { name: itemDetails.designName } })
                        };
                        addToCart(item);
                        totalQuantityAdded += quantity;
                    });

                    if (totalQuantityAdded > 0 && !stockError) {
                        showToast(`${totalQuantityAdded} item${totalQuantityAdded > 1 ? 's' : ''} added to cart!`);
                        selectedSizeNodes.forEach(node => node.classList.remove('selected'));
                        card.querySelector('.design-option.selected')?.classList.remove('selected');
                    }
                }
            });

            // --- CART LOGIC ---
            const addToCart = (item) => {
                const existingItem = cart.find(cartItem => cartItem.id === item.id);
                if (existingItem) {
                    existingItem.quantity += item.quantity;
                } else {
                    cart.push(item);
                }
                updateCart();
            };

            const updateCart = () => {
                localStorage.setItem(cartStorageKey, JSON.stringify(cart));
                renderCartItems();
                updateCartCount();
                updateCartSubtotal();
                updateStockDisplay(); // This is the key change!
                whatsappBtn.disabled = cart.length === 0;
            };

            const renderCartItems = () => {
                cartItemsContainer.innerHTML = '';
                if (cart.length === 0) {
                    emptyCartMessage.style.display = 'block';
                } else {
                    emptyCartMessage.style.display = 'none';
                    cart.forEach(item => {
                        const cartItemEl = document.createElement('div');
                        cartItemEl.className = 'flex items-center space-x-3 sm:space-x-4 mb-5 pb-5 border-b last:border-b-0 cart-item-enter';
                        cartItemEl.innerHTML = `
                            <img src="${item.image}" alt="${item.name}" class="w-16 h-20 sm:w-20 sm:h-24 object-cover rounded-md">
                            <div class="flex-grow">
                                <p class="font-semibold">${item.name}</p>
                                <p class="text-sm text-gray-500">Color: ${item.color}</p>
                                <p class="text-sm text-gray-500">Size: ${item.size}</p>
                                ${item.design ? `<p class="text-sm text-gray-500 font-medium">Design: ${item.design.name}</p>` : ''}
                                <p class="font-bold mt-1">â‚¹${item.price}</p>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center border rounded-md">
                                    <button class="px-2 py-1 text-gray-600 hover:bg-gray-100" data-itemid="${item.id}" data-action="decrease">-</button>
                                    <span class="px-3">${item.quantity}</span>
                                    <button class="px-2 py-1 text-gray-600 hover:bg-gray-100" data-itemid="${item.id}" data-action="increase">+</button>
                                </div>
                                <button class="text-xs text-red-500 hover:underline mt-2" data-itemid="${item.id}" data-action="remove">Remove</button>
                            </div>
                        `;
                        cartItemsContainer.appendChild(cartItemEl);
                        requestAnimationFrame(() => cartItemEl.classList.add('cart-item-enter-active'));
                    });
                }
            };
            
            cartItemsContainer.addEventListener('click', (e) => {
                if(e.target.tagName !== 'BUTTON') return;
                const itemId = e.target.dataset.itemid;
                const action = e.target.dataset.action;
                const itemIndex = cart.findIndex(item => item.id === itemId);
                if (itemIndex === -1) return;

                if (action === 'increase') {
                    const item = cart[itemIndex];
                    const product = products.find(p => p.id === item.productId);
                    if (product) {
                        const colorData = product.colors.find(c => c.name === item.color);
                        if (colorData) {
                            const totalStock = colorData.stockBySize?.[item.size] || 0;
                            if (item.quantity < totalStock) {
                                cart[itemIndex].quantity++;
                            } else {
                                showToast('No more stock available for this item.', true);
                                return; // Stop the function here
                            }
                        } else {
                           cart[itemIndex].quantity++; // Failsafe if data is missing
                        }
                    } else {
                        cart[itemIndex].quantity++; // Failsafe if product is missing
                    }
                } else if (action === 'decrease') {
                    cart[itemIndex].quantity--;
                    if (cart[itemIndex].quantity <= 0) cart.splice(itemIndex, 1);
                } else if (action === 'remove') {
                    cart.splice(itemIndex, 1);
                }
                
                updateCart();
            });

            const updateCartCount = () => {
                cartCountEl.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            };

            const updateCartSubtotal = () => {
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                cartSubtotalEl.textContent = `â‚¹${subtotal.toFixed(2)}`;
            };

            const openCart = () => {
                cartModal.classList.remove('hidden');
                setTimeout(() => cartPanel.classList.remove('translate-x-full'), 10);
            };

            const closeCart = () => {
                cartPanel.classList.add('translate-x-full');
                setTimeout(() => cartModal.classList.add('hidden'), 300);
            };
            
            cartButton.addEventListener('click', openCart);
            closeCartBtn.addEventListener('click', closeCart);
            cartModal.addEventListener('click', (e) => e.target === cartModal && closeCart());

            // --- WHATSAPP ORDER LOGIC ---
            whatsappBtn.addEventListener('click', () => {
                if (cart.length === 0) return;
                let message = `Hello LAFANDAR, I'd like to place an order:\n\n*Order Summary:*\n\n`;
                cart.forEach((item, index) => {
                    message += `*${index + 1}. ${item.name}*\n   - Color: ${item.color}\n   - Size: ${item.size}\n`;
                    if (item.design) message += `   - Design: ${item.design.name}\n`;
                    message += `   - Quantity: ${item.quantity}\n   - Price: â‚¹${item.price}\n\n`;
                });
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                message += `--------------------\n*Total Items:* ${cart.reduce((sum, item) => sum + item.quantity, 0)}\n*Subtotal:* â‚¹${subtotal.toFixed(2)}\n\nPlease confirm my order. Thank you!`;
                window.open(`https://wa.me/${whatsAppNumber}?text=${encodeURIComponent(message)}`, '_blank');
            });

            // --- DESIGN PREVIEW MODAL LOGIC ---
            const openDesignModal = (imageUrl) => {
                designModalImage.src = imageUrl;
                designModal.classList.remove('hidden');
                designModal.classList.add('flex');
                setTimeout(() => designModalContent.style.transform = 'scale(1)', 10);
            };
            const closeDesignModal = () => {
                designModalContent.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    designModal.classList.add('hidden');
                    designModal.classList.remove('flex');
                }, 200);
            };
            closeDesignBtn.addEventListener('click', closeDesignModal);
            designModal.addEventListener('click', (e) => e.target === designModal && closeDesignModal());
            document.addEventListener('keydown', (e) => e.key === 'Escape' && !designModal.classList.contains('hidden') && closeDesignModal());

            // --- TOAST NOTIFICATION ---
            let toastTimer;
            const showToast = (message, isError = false) => {
                toastMessage.textContent = message;
                toast.className = `toast fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg flex items-center z-[100] ${isError ? 'bg-red-600' : 'bg-green-600'}`;
                toast.classList.add('show');
                clearTimeout(toastTimer);
                toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
            };

            // --- INITIALIZATION ---
            updateCart();
        });
    </script>
</body>
</html>

